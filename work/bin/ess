#!/usr/bin/perl

use XML::Simple;
use LWP::Simple;

my $feed;

if (@ARGV == 1) {
    get_feed();
    my $show = shift;
    my @shows = select_show($show);
    if (@shows > 1) {
        print "Multiple shows found for criterion '$show'\n";
        exit 1;
    }
    my $link = $feed->{channel}{item}[$shows[0]]{link};
    $link =~ s/\/listen.pls$//;
    exec "mplayer -cache 512 '$link'";
    die "couldn't fork mplayer: $!\n";
}
elsif (@ARGV == 0) {
    get_feed();
    for (0..@{$feed->{channel}{item}}-1) {
        show_title($_);
    }
}
else {
    usage();
}

sub get_feed {
    return if $feed;
    $feed = XMLin(get('http://ess.tv/ess.rss')) or die "Couldn't get feed\n";
}

sub select_show {
    my ($crit) = @_;
    if ($crit =~ /^\d+$/) {
        return $crit-1;
    }
    else {
        my @matches;
        for my $i (0..@{$feed->{channel}{item}}-1) {
            if ($feed->{channel}{item}[$i]{title} =~ /$crit/i) {
                push @matches, $i;
            }
        }
        if (@matches == 0) {
            print "No match found for '$crit'\n";
            exit 1;
        }
        else {
            return @matches;
        }
    }
}

sub show_title {
    my ($num) = @_;
    printf "ESS %02d: %s\n", $num+1, $feed->{channel}{item}[$num]{title}, "\n";
}

sub usage {
    print <<EOU;
Usage: ess command [args]
  Commands:
  ess                        Show what is playing on all channels
  ess <criterion>            Watch the specified show
EOU
    exit;
}
